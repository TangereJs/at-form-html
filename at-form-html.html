<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-form-behaviors/at-form-behaviors.html">
<link rel="import" href="at-form-html-input-validation.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="quill-import.html">

<dom-module id="at-form-html">
  <template>
    <style include="at-form-common"></style>
    <style include="quill-bubble"></style>
    <style include="quill-snow"></style>
    <style>
      :host * {
        box-sizing: border-box;
      }

      :host {
        @apply(--at-form-host);
        display: block;
      }

      #hint {
        min-height: 14px;
        margin-bottom: 8px;
      }
    </style>
    <div id="atContainer" class="at-container">
      <iron-label id="label" on-tap="focus">{{label}}</iron-label>
      <div id="contentContainer" class="at-content-container">
        <div id="toolbarContainer">
          <!-- <span class="ql-formats">
          <select class="ql-font"></select>
          <select class="ql-size"></select>
          </span> -->
          <span class="ql-formats">
            <select class="ql-header"  hidden$="{{standardToolbar}}">
              <option value="1">Header 1</option>
              <option value="2">Header 2</option>
              <option value="3">Header 3</option>
              <option value="4">Header 4</option>
              <option value="5">Header 5</option>
              <option value="7">Normal</option>
            </select>
            <select class="ql-header"  hidden$="{{!standardToolbar}}">
              <option value="1">Header 1</option>
              <option value="2">Header 2</option>
              <option value="3">Header 3</option>
              <option value="7">Normal</option>
            </select>
          </span>
          <span class="ql-formats">
            <button class="ql-bold" title="Bold"></button>
            <button class="ql-italic" title="Italic"></button>
            <button class="ql-underline" title="Underline"></button>
            <button class="ql-strike" title="strike" hidden$="{{standardToolbar}}"></button>
          </span>
          <span class="ql-formats" hidden$="{{standardToolbar}}">
            <select class="ql-color" title="Text Color"></select>
            <select class="ql-background" title="Text Background Color"></select>
          </span>
          <!-- <span class="ql-formats">
          <button class="ql-script" value="sub"></button>
          <button class="ql-script" value="super"></button>
          </span> -->
          <span class="ql-formats" hidden$="{{standardToolbar}}">
            <button class="ql-header" value="1" title="Header 1"></button>
            <button class="ql-header" value="2" title="Header 2"></button>
            <button class="ql-blockquote" title="Blockquote"></button>
            <button class="ql-code-block" title="Code Clock"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-list" value="ordered" title="Numbered List"></button>
            <button class="ql-list" value="bullet" title="Bullet List"></button>
            <button class="ql-indent" value="-1" title="Decrease Indent" hidden$="{{standardToolbar}}"></button>
            <button class="ql-indent" value="+1" title="Indent" hidden$="{{standardToolbar}}"></button>
          </span>
          <span class="ql-formats" hidden$="{{standardToolbar}}">
            <!-- <button class="ql-direction" value="rtl"></button> -->
            <select class="ql-align" title="Align">></select>
          </span>
          <span class="ql-formats">
            <button class="ql-link" title="Link"></button>
            <button class="ql-image" title="Image" hidden$="{{standardToolbar}}"></button>
            <button class="ql-video" title="Video" hidden$="{{standardToolbar}}"></button>
            <!-- <button class="ql-formula"></button>> -->
          </span>
          <span class="ql-formats">
            <button class="ql-clean" title="Clear Formating"></button>
          </span>
        </div>
        <div id="editorContainer"></div>
      </div>
      <div id="hint"></div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-form-html',
      behaviors: [Tangere.behaviors.i18n, Tangere.behaviors.formUIGeneric, Tangere.behaviors.AtFormHtmlInputValidation],
      properties: {
        /**
         * Element's label for element display purposes
         * @property label
         * @type String
         * @default ''
         */
        label: {
          type: String,
          value: '',
          title: 'Label'
        },

        /**
         * Hides element's label
         * @property hideLabel
         * @type Boolean
         * @default false
         */
        hideLabel: {
          type: Boolean,
          value: false,
          observer: '_hideLabelChanged',
          title: 'Do not show the label'
        },

        /**
         * Element's disabled state
         * @property disabled
         * @type Boolean
         * @default false
         */
        disabled: {
          type: Boolean,
          value: false,
          observer: '_disabledChanged',
          title: 'Field value can not be changed'
        },

        /**
        * Hides the element. When hidden nothing is displayed for the element
        * @property hide
        * @type Boolean
        * @default false
        */
        hide: {
          type: Boolean,
          value: false,
          observer: '_hideChanged',
          title: 'Field is invisible'
        },

        /**
         * Element's required state for element validation purposes
         * @property required
         * @type Boolean
         * @default false
         */
        required: {
          type: Boolean,
          value: false,
          title: 'Input required'
        },

        /**
         * Maximum number of characters across all lines allowed on the element. Use 0 (zero) for no limit
         * @property maxLines
         * @type Number
         * @default 0
         */
        maxChars: {
          type: Number,
          value: 0,
          title: 'Maximum number of characters'
        },

        /**
         * Elements value
         * @property value
         * @type String
         * @default ''
         */
        value: {
          type: String,
          xtype: 'code',
          mode: 'htmlmixed',
          xgridcols: "12",
          value: "",
          observer: '_valueChanged',
          title: 'Value'
        },

        /**
         * Placeholder when there is no content
         * @property placeholder
         * @type String
         * @default null
         */
        placeholder: {
          type: String,
          value: null,
          observer: '_scheduleReload'
        },

        /**
         * Whitelist for all formats to allow. Defaults to enable all formats
         * @property formats
         * @type Array
         * @default null
         */
        formats: {
          type: Array,
          value: function() { return null; },
          observer: '_scheduleReload'
        },

        /**
         * The Quill theme. Choose either "snow" or "bubble".
         * @property theme
         * @type String
         * @default snow
         */
        theme: {
          type: String,
          value: 'snow',
          xtype: 'enum',
          xvaluelist: [{title: 'Snow', value: 'snow'}, {title: 'Bubble', value: 'bubble'}],
          observer: '_scheduleReload'
        },

        /**
         * Ops Mode if true value will be emitted as quill delta. If false value will be emitted as html
         * @property opsMode
         * @type Boolean
         * @default false
         */
        opsMode: {
          type: Boolean,
          value: false,
          observer: '_opsModeChanged'
        },

        /**
         * Type of toolbar. Standard toolbar has basic functions.
         * When false, full toolbar is displayed.
         * @property standardToolbar
         * @type Boolean
         * @default true
         */
        standardToolbar: {
          type: Boolean,
          value: true,
          title: 'Standard toolbar'
        },
      },

      observers: [
        '_internalValidStateUpdate(required, maxChars)',
        '_scheduleReload(placeholder, formats, theme)'
      ],

      $meta: [{
        title: "Html",
        type: "string",
        xtype: "html"
      }],

      _hideLabelChanged: function(newValue, oldValue) {
        this.toggleClass("hidden", newValue, this.$.label);
      },

      ready: function() {
        this._reloadTimeout = null;
        this._init();

        this._opsModeChanged(this.opsMode, "called from ready");
        this._internalValidStateUpdate(this.required, this.maxChars);
      },

      _scheduleReload: function (placeholder, formats, theme) {
        if (this._reloadTimeout === null) {
          var self = this;
          this._reloadTimeout = window.setTimeout(function() {
            self._init();
          }, 0);
        }
      },

      _init: function () {

        var self = this;

        var editorContainer = this.$.editorContainer;
        var children = editorContainer.children;
        for (var i = children.length - 1; i >= 0; i--) {
          var child = children[i];
          Polymer.dom(child.parentElement).removeChild(child);
        }

        this.modules = {
          formula: false,
          syntax: false,
          toolbar: this.$.toolbarContainer
        };

        var configuration = {
          bounds: this,
          modules: this.modules,
          theme: this.theme,
          readOnly: this.readOnly,
          placeholder: this.placeholder
        };
        if (this.formats != null) {
          configuration.formats = this.formats;
        }
        this.quill = new Quill(editorContainer, configuration);

        this.quill.on('text-change', function (event) {
          if (self._ignoreQuillTextChanged) { return; }
          self.validate();
        });

        // Make the custom styles work (quill adds html elements after ready is called)
        for (var i = 0; i < editorContainer.children.length; i++) {
          this.scopeSubtree(editorContainer.children[i], true);
        }

        if (this.disabled) {
          this.quill.disable();
        }

        // make sure init is not called again
        window.clearTimeout(this._reloadTimeout);
        this._reloadTimeout = null;

        this._isReady = true;
        this._valueChanged(this.value, "called from ready");
      },

      _opsModeChanged: function (newValue, oldValue) {
        if (!this._isReady) { return; }
        this._setOutputValue();
      },

      _disabledChanged: function(newValue, oldValue) {
        var label = this.$.label;
        this.toggleClass('disabled', newValue, label);
        var contentContainer = this.$.contentContainer;
        this.toggleClass('disabled', newValue, contentContainer);

        if (this._isReady) {
          this.quill.enable(!newValue);
        }
      },

      _hideChanged: function(newValue, oldValue) {
        var atContainer = this.$.atContainer;
        this.toggleClass('hidden', newValue, atContainer);
      },

      _internalValidStateUpdate: function (required, maxChars) {
        if (this._isReady) {
          this.validate();
        }
      },

      _valueChanged: function(newValue, oldValue) {
        if (!this._isReady) { return; }

        var valueToSet = [null, "null"].indexOf(newValue) !== -1 ? "" : newValue;

        if (!this._isInternalUpdate) {
          this._ignoreQuillTextChanged = true;
          this._setQuillValue(valueToSet);
          this._ignoreQuillTextChanged = false;

          if (this.autoValidate) { this._validate(true); }
        }

        this._fireValueChangedEvent(this.value);
      },

      _getFocusableElement: function() {
        return this;
      },

      focus: function () {
        this.quill.focus();
      },

      validate: function (showError) {

        if (showError === undefined) { showError = this.autoValidate; }

        // validate must validate the current value
        var inputValue = this._getQuillValue();
        var quillLength = this._getQuillValueLength(inputValue);

        if ([null, "null", ""].indexOf(this.value) !== -1 && quillLength > 1 ) {
          // if value is set to null but quill input is not empty set value to input value
          this._setOutputValue(inputValue);
        } else if ([null, "null", ""].indexOf(this.value) === -1) {
          // if value is not null
          var valueQuillLength = this._getQuillValueLength(this.value);
          var cmpValue = this.value.replace(/\\n/gm,"");
          var cmpInputValue = inputValue.replace(/\\n/gm,"");
          if (valueQuillLength !== -1 && (valueQuillLength !== quillLength || (valueQuillLength > 1 && cmpValue !== cmpInputValue))) {
            this._setOutputValue(inputValue);
          }
        }

        return this._validate(showError);
      },

      _validate: function (showError) {
        var validationResult = this._validateBaseData();
        this._handleValidationResult(validationResult);
        if (!validationResult.isValid) {
          return validationResult.isValid;
        }

        validationResult = this._validateData(this, this.value, this.T.bind(this));
        if (showError) { this._handleValidationResult(validationResult); }

        return validationResult.isValid;
      },

      _updateUIValidState: function(isValid) {
        var label = this.$.label;
        this.toggleClass('error', !isValid, label);
        var contentContainer = this.$.contentContainer;
        this.toggleClass('error', !isValid, contentContainer);
        var atContainer = this.$.atContainer;
        var codeMirrorCode = atContainer.getElementsByClassName('CodeMirror-lines')[0];
        this.toggleClass('error', !isValid, codeMirrorCode);
        var hint = this.$.hint;
        this.toggleClass('error', !isValid, hint);
      },

      //*******************************************************************************************************************
      // Helper functions
      //*******************************************************************************************************************
      /*
        Sets the .value property for at-form-html (which is the output value)
        newValue input parameter is either undefined, quill delta (as json string or object) or html string
        if newValue is undefined current content of this.quill.getContents() will be set as output
        otherwise content of newValue will be set as output
        if newValue is empty html or empty quill delta object, output value will be set to empty string
      */
      _setOutputValue: function (newValue) {
        var inputValue = newValue;
        if (!newValue) {
          inputValue = this._getQuillValue();
        }

        this._isInternalUpdate = true;
        var valueLength = this._getQuillValueLength(inputValue);
        inputValue = valueLength === 1 ? "" : inputValue;
        this.value = inputValue;
        this._fireValueChangedEvent(inputValue);
        this._isInternalUpdate = false;
      },

      /*
        Returns current quill value, respecting opsMode property
        if opsMode is true, quill delta object will be returned as json string
        if opsMode is false, innerHTML of quill.root will be returned
      */
      _getQuillValue: function() {
        var result = "";
        var opsMode = this.opsMode;
        if (opsMode) {
          // return value as quill delta object as json
          result = JSON.stringify(this.quill.getContents());
        } else {
          // return value as html
          result = Polymer.dom(this.quill.root).innerHTML;
        }
        return result;
      },

      /*
        Sets quill value, respecting opsMode property
        if opsMode is true quill value is set using quill.setContents function
        if opsMode is false quill value is set using quill.clipboard.dangerouslyPasteHTML function
      */
      _setQuillValue: function(newValue) {
        var opsMode = this.opsMode;
        if (opsMode) {
          try {
            var parsedObject = JSON.parse(newValue);
            this.quill.setContents(parsedObject);
          } catch (e) {
            console.log(e);
            this.quill.setContents(newValue);
          }
        } else {
          this.quill.clipboard.dangerouslyPasteHTML(newValue);
        }
      },

      /*
        Calculates and retunrs length of passed quillStringValue
        if quillStringValue is quill delta json string its set on a quill instance and result of quill.getLength() function is returned
        if quillStringValue is html string its set on a quill instance and result of quill.getLength() function is returned
      */
      _getQuillValueLength: function(quillStringValue) {
        var measuringInstance = this._getLentghMeasuringInstance();

        if (this.opsMode) {
          try {
            var parsedObject = JSON.parse(quillStringValue);
            measuringInstance.setContents(parsedObject);
          } catch (e) {
            measuringInstance.setContents(quillStringValue);
          }
        } else {
          measuringInstance.clipboard.dangerouslyPasteHTML(quillStringValue);
        }

        return measuringInstance.getLength();
      },

      /*
        Getter for a special private variable of type Quill used for measuring length of string values named __lengthMeasuringInstance
      */
      _getLentghMeasuringInstance: function() {
        if (!this.__lengthMeasuringInstance) {
          var container = document.createElement('div');
          this.__lengthMeasuringInstance = new Quill(container, {});
        }
        var result = this.__lengthMeasuringInstance;
        return result;
      }

    });
  </script>
</dom-module>
